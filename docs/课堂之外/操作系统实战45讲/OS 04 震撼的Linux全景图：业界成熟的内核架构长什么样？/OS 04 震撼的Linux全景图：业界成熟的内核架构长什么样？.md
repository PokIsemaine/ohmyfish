# OS 04 震撼的Linux全景图：业界成熟的内核架构长什么样？

## Linux 内核

**Linux 的基本思想是一切都是文件**：每个文件都有确定的用途，包括用户数据、命令、配置参数、硬件设备等对于操作系统内核而言，都被视为各种类型的文件。**Linux 支持多用户**，各个用户对于自己的文件有自己特殊的权利，保证了各用户之间互不影响。**多任务则是现代操作系统最重要的一个特点，Linux 可以使多个程序同时并独立地运行**。

![img](https://static001.geekbang.org/resource/image/92/cb/92ec3d008c77bb66a148772d3c5ea9cb.png?wh=2160*1620)

![img](https://static001.geekbang.org/resource/image/97/c9/97e7e66f9dcbddb1294ef9b7552fbac9.jpg?wh=3046x1502)



Linux内核是宏内核，虽然没啥层次关系，耦合度很高，但是性能很好



## Darwin-XNU 内核

Darwin苹果公司开发的开放源代码系统

Darwin 使用了一种微内核（Mach）和相应的固件来支持不同的处理器平台，并提供操作系统原始的基础服务，上层的功能性系统服务和工具则是整合了 BSD 系统所提供的。苹果公司还为其开发了大量的库、框架和服务，不过它们都工作在用户态且闭源。

![img](https://static001.geekbang.org/resource/image/5e/8d/5e9bd6dd86fba5482fab14b6b292aa8d.jpg?wh=4462*4410)

混合使用了Mach内核（微内核）和BSD系统。根据调用系统API号码的正负区分是调用March内核服务还是BSD内核服务。





## Windows NT内核

![img](https://static001.geekbang.org/resource/image/c5/c9/c547b6252736375fcdb1456e6dfaa3c9.jpg?wh=4268*4905)



NT内核架构：层次清晰明了，高内聚，低耦合

HAL硬件抽象层，不同硬件平台只要提供对应的HAL就可以移植系统了

HAL层上有个小内核，小内核上是各种内核组件

**每个执行体互相独立，只对外提供相应的接口**，其它执行体要通过内核模式可调用接口和其它执行体通信或者请求其完成相应的功能服务，而不是通过消息



**Linux 性能良好，结构异常复杂，不利于问题的排查和功能的扩展，而 Darwin-XNU 和 Windows 结构良好，层面分明，利于功能扩展，不容易产生问题且性能稳定。**

## 自问自答（核心）

### 1.Windows NT 内核属于哪种架构类型？

NT是混合内核，内核相较于linux来说小，但是仍有一些模块在内核，也有相当多的模块在用户态，架构额外清晰。

### 2.为什么现在吹Linux？

优点是性能高，但其架构上的缺陷也很明显

实际上Linux内核架构是比较糟糕的，但是他开源而且免费，随时可以优化啊

Windows 不开源研究内核不方便，这也造成了一些认知偏见

### 3.微内核，宏内核，混合内核区别是什么？

所以宏内核相当于所有的功能都**耦合**在一起，**放在内核内**
微内核是把大多数功能**解耦**出来，**放在用户态**，使用IPC在用户态调用服务进程
混合结构其实与微内核相似，只不过**解耦**出来的这些功能依然**放在内核里**，不通过IPC调用

### 4.为什么最近几年很火在linux上跑的微服务架构，本质对应在宏内核的架构上运行着微内核模式的微服务架构？

