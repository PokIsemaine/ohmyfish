# OS 03 黑盒之中有什么：内核结构与设计

## 黑盒之中有什么

内核是计算机资源的管理者，那么我们就需要知道**有哪些资源需要管理**

计算机资源主要分为：硬件资源和软件资源

硬件资源：总线，CPU，内存，硬盘，网卡，显卡，各种I/O设备

![img](https://static001.geekbang.org/resource/image/28/14/28cc064d767d792071a789a5b4e7d714.jpg?wh=4367*2105)

软件资源：各种数据，文件，程序



接下来我们需要思考**如何管理这些资源**

1. CPU：进程管理
2. 内存：分配和释放内存
3. 显卡：图形显示系统，GUI
4. 网卡：网络协议栈
5. 各种I/O设备:I/O管理器
6. 各种不同硬件：驱动程序



## 内核架构

### 宏内核

宏内核就是把以上诸如管理进程的代码、管理内存的代码、管理各种 I/O 设备的代码、文件系统的代码、图形系统代码以及其它功能模块的代码，把这些所有的代码经过编译，最后链接在一起，形成一个大的可执行程序



优点：性能好

缺陷：没有模块化，没有扩展性，没有移植性，耦合度太高

### 微内核

仅仅只有进程调度、处理中断、内存空间映射、进程间通信等功能

实际去实现功能由服务进程去完成

进程通信机制：消息。

应用程序发请求给内核，内核让服务进程干活，服务进程把结果返回给内核，内核再把结果给应用程序



优点：结构清晰利于协作开发，移植性好，代码量少，伸缩性扩展性好

缺点：消息传送和进程切换开销大

## 分离硬件的相关性

计算机领域的一个基本方法是增加一个抽象层，从而使得抽象层的上下两层独立地发展，所以在内核内部再分若干层也不足为怪

今天如此庞杂的计算机，其实也是一层一层地构建起来的，从硬件层到操作系统层再到应用软件层这样构建。**分层的主要目的和好处在于屏蔽底层细节，使上层开发更加简单**

分离硬件的相关性，就是要把操作硬件和处理硬件功能差异的代码抽离出来，形成一个独立的软件抽象层，对外提供相应的接口，方便上层开

进程调度模块：

1. **进程调度**，它的目的是要从众多进程中**选择一个将要运行的进程**，当然有各种选择的算法，例如，轮转算法、优先级算法等。
2. **进程切换**，它的目的是停止当前进程，运行新的进程，主要动作是保存当前进程的**机器上下文**，装载新进程的机器上下文

不同平台的进程调度大致是相同的，不过进程切换有很大不同，其原因是不同硬件平台机器上下文差异很大。如果我们把进程切换单独分出来一个抽象层，那么我们只需针对每个硬件平台修改一层的代码即可，增加了移植性

## 我们的选择

我们的内核结构分为三层：**内核硬件层，内核功能层，内核接口层**

内核接口层主要是定义了一套 UNIX 接口的子集

内核功能层主要完成 I/O 管理组件、内存管理组件、文件系统组件、进程管理组件、图形系统组件、网络组件、安全组件的通用功能型代码

内核硬件层则完成其内核组件对应的具体硬件平台相关的代码![img](https://static001.geekbang.org/resource/image/6c/3c/6cf68bebe4f114f00f848d1d5679d33c.jpg?wh=4843*3176)



## 自我自问自答（核心）

### 1.其实我们的内核架构不是我们首创的，它是属于微内核、宏内核之外的第三种架构，请问这是什么架构？

参考：https://zhuanlan.zhihu.com/p/394560786

混合内核架构

宏内核和微内核各有优缺点，它们就如同两个极端。而将两者中和一下，就形成了混合内核。混合内核的结构其实与微内核相似，但为了提高性能，混合内核中会将一些原本微内核中运行在用户层的功能模块放回内核中，而不常用的，或者需要的时间很长的功能模块还是放在用户层。当然这只是其中的一种情况，混合内核往往还会有其他形式，等下在拓展中会看到其他形式的混合内核。总而言之，混合内核就是结合了宏内核和微内核的特点，记住这点就好。

Linux 宏内核，Windows和Mac混合内核

![img](https://static001.geekbang.org/resource/image/92/cb/92ec3d008c77bb66a148772d3c5ea9cb.png?wh=2160*1620)