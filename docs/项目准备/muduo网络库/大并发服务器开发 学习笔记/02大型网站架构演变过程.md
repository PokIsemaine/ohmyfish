# 02大型网站架构演变过程

大型网站架构是大并发服务器架构的典型案例，可以通过大型网站架构加深对大并发服务器架构的理解

大型网站服务器架构是一个 `B/S`架构，本质上也是`C/S`架构

下面说的那些组件都是服务器编程，都要用到socket编程，可以Java实现也可以C++实现

## 一、 web 服务器与数据库服务器分离

web 服务器 包含：http 服务器、应用服务器等，如果和数据库服务器部署在一块，两者会互相影响，降低速度

我们可以将 web 服务器与数据库分离，同时将web服务器中的动静资源分离

![image-20220104194715052](https://s2.loli.net/2022/01/04/UHw9emaWlxJOdjE.png)

web服务器中的动静资源分离：

浏览器请求分为静态请求和动态请求

静态请求：html、js、css、img等

动态请求：php、jsp等

我们将动静资源分离，http服务器主要处理静态请求、应用服务器主要处理动态请求

主流的http服务器：Apache、Nginx等（这两个也可以处理php,但是jsp处理不了），一般称为前端服务器

主流的应用服务器：JBoss、Tomcat等，一般称为后端服务器主要用来处理业务逻辑

![image-20220104194744325](https://s2.loli.net/2022/01/04/trvHhz24CgE5sfj.png)

## 二、缓存处理

客户端（浏览器）缓存：减少对网站的访问

前端页面缓存（squid）：主要是静态页面缓存，减少对web服务器的请求

页面片段缓存ESI(Edge Side Includes)：对动态页面中相对静态的部分缓存

本地数据缓存：对数据库数据缓存，减少对数据库的查询

![image-20220104195033578](https://s2.loli.net/2022/01/04/LhQCMYnk42KtOb3.png)

## 三、web server集群+读写分离

增加 web 服务器形成web server集群，我们需要做一个负载均衡

![image-20220104195644154](https://s2.loli.net/2022/01/04/M5wBWOATbXGdEYv.png)



服务器增加了，数据库瓶颈出现，进行读写分离，采用主从结构，并使用replication机制进行同步

![image-20220104195652709](https://s2.loli.net/2022/01/04/calHYs4RDBTIu7h.png)



### 负载均衡

前端负载均衡

* DNS 负载均衡：在DNS服务器中，可以**为多个不同的地址配置同一个名字**，对于不同的客户机访问同一个名字，得到不同的地址
* 反向代理：使用代理服务器将请求发给内部服务器，**让代理服务器将请求均匀转发给多台内部web服务器之一**，从而达到负载均衡的目的。标准代理方式是客户使用代理访问多个外部Web服务器，而这种代理方式是**多个客户使用它访问内部Web服务器**，因此也被称为反向代理模式
* 基于 NAT 的负载均衡技术：和反向代理类似，通过 NAT 地址转换映射到 web server
* LVS
* F5 硬件负载均衡

应用服务器负载均衡：增加一个任务服务器（被动接受模式和主动接受模式）

数据库负载均衡



## 四、CDN、分布式缓存、分库分表

**CDN**: 内容分发网络，不同地区或运营商接入，速度都得到提升

![image-20220104200711181](https://s2.loli.net/2022/01/04/3FoRZXImkU9tMqh.png)

**分布式缓存**：所有缓存对主机是共享的

目前流行分布式缓存方案：memcached、membase、redis等，基本上当前的NoSQL方案都可以用来做分布式缓存方案



![image-20220104200727318](https://s2.loli.net/2022/01/04/nKvoXbORyc61fBs.png)





**分库分表**：数据库数据量比较大，并发量大的时候容易出现锁竞争。我们对数据库进行分库分表，尽量避免锁竞争

由于分摊到了多个数据库，我们还要增加一个`DAL`层

分库：垂直分区

![image-20220104200851176](https://s2.loli.net/2022/01/04/bOGZWnfQSzRsyD8.png)

分表：水平分区

![image-20220104200912815](https://s2.loli.net/2022/01/04/96MXTJHZzOFxhKi.png)

## 五、多数据中心+分布式存储与计算

关系数据库的事务处理（锁）、大表连接、表的交流比较影响性能，并发能力不如`NoSql`。

对于一致性要求不是很高的数据，没必要保存在关系数据库中。我们可以把这些数据放到数据中心（一般都是`NoSQL`并用`Key-Value`形式存储）

数据中心一般是基于 `DFS` 分布式文件系统，因为一般文件系统在磁盘查找小文件（小的块散落在磁盘上）磁盘转的时间比较久，我们可以把相关性比较高的小文件放在一个块里，这要操作系统先找到一个比较大的块，然后再在这个块里找，效率就比较高（数据库也有自己的文件系统）

![image-20220104201154072](https://s2.loli.net/2022/01/04/Rd7HWTKcbXxEsrf.png)

`DFS`分布式文件系统，如：Lustre\HDFS\GFS\TFS\FreeNas等

`Key-Value DB`，也作为`NoSQL`解决方案，如:BigTable\Tair\Hbase\HyperTable等

`Map/Reduce`算法（计算框架），基本上现有`NoSQL`数据库中都支持此算法。例如统计单词数，文件很大单台机器一个个放内存太慢了，我们可以考虑多台机器一起算，这个其实就是分布式计算。Map过程：每台机器把计算结果存为`Key-VCalue DB`，`Reduce`数据：把多台机器数据进行排序（可以在map过程中做）合并，得到最终结果。

![image-20220104202642579](https://s2.loli.net/2022/01/04/wZWxucAQ7vTdKiM.png)



提供完整解决方案：
   Google(GFS|BigTable|Map/Reduce)
   Apache Hadoop(HDFS|HBase|Map/Reduce) 



## 总结

大型网站架构演变过程：

1. web 服务器与数据库服务器分离，web 服务器动态静态资源分离
2. 缓存处理：客户端缓存，前端页面缓存，页面片段缓存，本地数据缓存
3. web server集群+读写分离+负载均衡
4. CDN、分布式缓存、分库分表
5. 多数据中心+分布式存储与计算