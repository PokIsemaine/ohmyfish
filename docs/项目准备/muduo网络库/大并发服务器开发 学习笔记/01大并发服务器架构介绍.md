# 01大并发服务器架构介绍

## 服务器设计目标

* 高性能：对大量并发请求做出快速响应
* 高可用：7X24，支持故障转移`failover`
* 伸缩性：业务分离，灵活部署，部件可分离

## 分布式

* 负载均衡
* 分布式存储
* 分布式计算



## 一个典型的服务器结构

* 任何网络系统都可以抽象为C/S结构

![image-20220103211242363](https://s2.loli.net/2022/01/03/scBO1gohEUnwFjT.png)

主要三方面：网络I/O + 服务器高性能编程基础 + 数据库

* 网络I/O ，Linux 系统采用 epoll 技术
* 数据库限制比较大主要有两个问题：超出数据库连接数，超出时限



**超出数据库连接数**：

数据库并发连接数10个，应用服务器这边有1000个并发请求，将会有990个请求失败

解决方案：增加一个队列（数据库访问层DAL）

DAL：队列服务 + 连接池

数据库从 DAL中直接选取已连接的资源进行连接



**增加DAL**

![image-20220103211825328](https://s2.loli.net/2022/01/03/fDFmj2rHedgqQIW.png)







**超出时限**：

数据库并发连接数10个，数据库1秒钟之内最能处理1000个请求，应用服务器这边有10000个并发请求，会出现0-10秒的等待

如果系统规定响应时间为5s，那么数据库并发能力为5000,不能处理 10000 个请求



解决方案：

* 降低数据库压力：简化数据库业务逻辑，把主要业务逻辑移动到应用服务系统中

* 增加缓存 `cache`：客户端提交请求先从缓存获取数据，如果有就直接从缓存拿，减少数据库访问、

	

**增加缓存**

![image-20220103212804251](https://s2.loli.net/2022/01/03/16VQScrzbwaplI9.png)



缓存有两个问题

* 缓存`timeout`：缓存会过期，需要更新同步
	* 如果缓存失效，重新去数据库查询，实时性比较差
	* 一旦数据库中数据更新，立即通知前端的缓存更新，实时性比较高
* 缓存占用空间过多，内存不够
	* 缓存换页：将不活跃的数据换出内存，存入磁盘。
		* FIFO
		* LRU 最近最少使用
		* LFU 最不频繁使用
* 缓存既可以和 APP 部署在同一台机器上，也可以部署在单独的机器上
	* 如果部署和 APP 同一台机器上，那是局部缓存，只能这台机器用
	* 如果单独部署的话，大家都可以用，而且可以考虑多台机器做分布式缓存

上述技术不用自己写，已经有很多产品帮忙实现了

nosql：存一些一致性要求不是很高的数据，可以拿来当缓存使用

分布式缓存：redis、memcached



**增加分布式缓存**（这里APP的分开了只是表达有很多请求的意思，后面提到的应用服务器业务分割不一样）

![image-20220103214645679](https://s2.loli.net/2022/01/03/k9tNAMy1p5gPnCa.png)





**数据库写锁问题：**

并发量太大了，数据库容易出现锁竞争，写操作太多把数据库读操作阻塞了

一般的，数据库读操作比写操作频繁



解决方案：

数据库读写分离

数据库负载均衡 replication机制(用于同步)

数据库主从结构



**读写分离+负载均衡+主从结构**

![image-20220103220013785](https://s2.loli.net/2022/01/03/A8I4dnlzFuQJ9fP.png)





数据库牛逼起来了，现在压力来到了应用服务器选手这边！

如果APP所有业务都放在一块，那来了一堆请求那么应用服务器压力很大



解决方案：

* APP 分割，每个服务器专门处理某个 APP 的业务
* 业务分割，每个服务器专门处理某项业务
* 负载均衡：增加一个任务服务器监控（应用服务器提供查询接口）各个应用服务器当前负载（CPU高、IO高、并发高、内存换页高）
	* 选取负载最低的服务器分配任务，应用服务器被动接受任务。但是这样不一定公平，不同任务特点不同，计算出的负载可能没有可比性。
	* 应用服务器主动到任务服务器接受任务处理，如果应用服务器处理任务都相同，这样更加公平；如果不相同，可能会增加服务器负担
	* 任务服务器应该有多台，这样能够支持故障转移机制（通过心跳实现）



**APP分割+业务分割+负载均衡(任务服务器，心跳)**

![image-20220103222508905](https://s2.loli.net/2022/01/03/YvncDOeLFuxjSQN.png)





当数据库数据量特别大的时候，也会影响到数据库并行能力

我们可以采取数据分区（分库、分表）的方法

分库 垂直分区：数据库按照一定逻辑把表分散到不同数据库（比如一个数据库存用户表、一个存业务表、一个存基础表）

分表 水平分区（常用）：每个数据库都有用户表、业务表、基础表，把表里的记录水平切分到多个数据库



**水平分区**

![image-20220103225608594](https://s2.loli.net/2022/01/03/VFMNmZgeKd9TGEH.png)



高性能服务器编程技术

服务器性能四大杀手

* 数据拷贝：缓存
* 环境切换：该不该用多线程？理性创建线程
	* 单核服务器采用状态机编程（类似操作系统里的进程切换）效率最佳，如果使用多线程会增加线程间切换开销
	* 多核服务器采用多线程充分发挥性能，但是要经可能避免线程的环境切换，线程不是越多越好
* 内存分配：内存池
* 锁竞争：尽可能避免锁的使用，减少锁的竞争



## 总结

总结一下各部件用到的技术

I/O：Linux 采用 epoll

高性能服务器编程技术

* 缓存
* 状态机编程/理性多线程
* 内存池
* 减少锁竞争

数据库

* 增加DAL(队列服务+连接池)
* 增加缓存：分布式缓存
* 数据库读写分离
* 数据库主从结构
* 数据库负载均衡，replication机制进行数据同步
* 数据库分区，一般采用水平分区

