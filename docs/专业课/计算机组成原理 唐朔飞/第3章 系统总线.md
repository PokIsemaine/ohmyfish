# 第3章 系统总线

## 3.1 总线的基本概念

* 计算机系统的五大部件之间的互连方式有两种
	* 分散连接：各部件之间使用单独的连线
	* 总线连接：各部件连接到一组公共信息传输线上
* 某一时刻只允许有一个部件向总线发送信息，而多个部件可以同时从总线上接收相同的信息

## 3.2 总线的分类

* 按照数据传送方式可以分为并行传输总线和串行传输总线
* 并行传输总线可按传输数据宽度分为8位、16位、32位、64位等传输总线
* 按总线的使用范围划分分为计算机总线、测控总线、网络通信总线
* 按连接部件不同分为片内总线、系统总线、通信总线

### 3.2.1 片内总线

* 片内总线是指芯片内部的总线
* CPU 芯片内部、寄存器与寄存器之间、寄存器与算术逻辑单元 ALU 之间都由片内总线连接

### 3.2.2 系统总线

* 系统总线指CPU、主存、I/O设备等各大部件之间的信息传输线，又称板级总线
* 按照传输信息的不同可分为：数据总线、地址总线、控制总线
* 数据总线：
	* 传输各部件之间的数据信息，是双向传输总线
	* 位数与机器字长、存储字长有关。数据总线的位数称为数据总线宽度，是衡量系统性能的重要参数
* 地址总线：
	* 主要用来指出地址总线的源数据或目的数据在主存单元或 I/O 设备的地址
	* 由 CPU 输出，单向传输
	* 地址线位数与存储单元个数有关，地址线20根，对应存储单元$2^{20}$
* 控制总线：
	* 用来发出各种控制信号的传输线
	* 对于任一控制线而言，传输是单向的，由 CPU 发出
	* 对于控制线整体而言可以认为是双向的，对 CPU 而言 控制信号既有输入又有输出
	* 常见控制信号：时钟、复位、总线请求与允许、中断请求与响应、存储器读写、I/O 读写、传输响应

### 3.2.3 通信总线

* 通信总线用于计算机系统之间或计算机系统与其他系统之间的通信
* 按照传输方式可以分为串行通信和并行通信
* 串行通信，数据在单条 1 位宽的传输线上顺序分时传送
* 并行通信，数据在多条并行 1 位宽的传输线上，同时由源传送到目的地
* 并行通信适合近距离信息传输，速度快但价格高
* 串行通信适合远距离传送，速度慢但价格低
* 数据传输速率与距离成反比



## 3.3 总线特性及性能指标

### 3.3.1 总线特性

* 机械特性：机械连接方式上的一些性能
* 电器特性：高低电平要求
* 功能特性：每根传输线的功能
* 时间特性：任一根线在什么时间有效，信号互相存在一种有效的时序关系

### 3.3.2 总线性能指标

* 总线宽度：数据总线的根数
* 总线带宽：
	* 总线数据的传输速率，单位时间内总线上传输数据的位数，通常以美妙传输信息的字节数衡量，单位$MBps$。
	* $总线带宽=总线工作频率*(总线宽度/8)$
* 时钟同步/异步：总线数据与时钟同步则为同步总线，否则为异步总线
* 信号线数:地址总线、数据总线、控制总线数量之和
* 总线控制方式：突发工作、自动配置、仲裁方式、逻辑方式、计数方式
* 其他指标：负载能力、电源电压、总线宽度是否可扩展
	* 负载能力即驱动能力，指总线街上负载后输入输出的逻辑电平能否保持在正常额定范围内
	* 通常可用连接扩增电路板数来反映总线的负载能力

### 3.3.3 总线标准

* 总线标准，可视为系统与各模块、模块与模块之间的一个互连的标准界面。总线设计的接口可以视为通用接口。采用总线标准可以为计算机接口的软硬件设计提供方便。
* ISA 总线
* EISA 总线
* VESA(VL-BUS) 总线
* **PCI 总线**（广泛应用）：高性能、良好的兼容性、支持即插即用、支持多主设备能力、具有与处理器和存储器子系统完全并行操作的能力、提供数据和地址奇偶校验功能、支持两种标准电压、可扩充性好、软件兼容性好、采用多路复用技术
* AGP 总线：显示卡专用局部总线，处理三维数据
* RS-232C 总线
* **USB 总线**：真正即插即用、很强的连接能力、数据传输率（USB 1.0）有两种、标准统一、连接电缆轻巧、生命力强

## 3.4 总线结构

* 总线结构通常可以分为单总线结构和多总线结构两种

### 3.4.1 单总线结构

* 结构简单方便扩充

* 不允许两个以上的部件在同一时刻向总线传输信息，影响工作效率
* 有数据传输速率慢，CPU、主存、 I/O 设备传输速率不同步的问题

![image-20211231125334084](https://s2.loli.net/2021/12/31/M1pSEruDLn52dJY.png)

### 3.4.2 多总线结构

* 将速率不同的 I/O 设备进行分类，然后连接在不痛的通道上，那么计算机系统的工作效率会提高，由此发展成多总线结构

* 双总线结构：将速度较低的 I/O 设备分离出来，形成主存总线与 I/O总线分开的结构。CPU将部分功能下放给通道，使其对 I/O 设备有同意管理能力

![image-20211231125804437](../../../../../.config/Typora/typora-user-images/image-20211231125804437.png)

* 三总线结构1：
	* 主存总线用于 CPU 和主存之间的传输
	* I/O 总线提供 CPU 和 各类 I/O 设备之间传递信息，只有在 CPU 执行 I/O 指令的时候采用到
	* DMA 总线 用于高速 I/O （磁盘、磁带）与主存直接交换信息，不能与主存总线同时对主存存取
	* 任意时刻只能用一种总线

![image-20211231130257140](https://s2.loli.net/2021/12/31/CqeDfuRNVKFXbAo.png)

* 三总线结构2：

	* 增加了 Cache 和 CPU 之间的局部总线，和一条扩展总线
	* I/O 设备与主存之间的信息传输也不需要再通过 CPU
	* 扩展总线把各种 I/O 接口连接起来

	![image-20211231130511727](https://s2.loli.net/2021/12/31/7ZG2Yjhrd6tAMH8.png)

* 四总线结构

	* 采用了高速总线，使得一些高速 I/O 设备与 CPU 联系更加紧密

	![image-20211231130536971](https://s2.loli.net/2021/12/31/WXxu9nJBlacg7b2.png)

### 3.4.3 总线结构的举例

看书了解一下

## 3.5 总线控制

总线控制要解决如下问题

* 什么时候哪个部件发送信息
* 如何给信息传送定时
* 如何防止信息丢失
* 如何避免多个部件同时发送
* 如何规定接收信息的部件

总线控制主要包括：判优控制（仲裁逻辑）和通信控制

### 3.5.1 总线判优控制

* 总线上所连接的各类设备，按其对总线有无控制功能可分为主设备和从设备
	* 主设备对总线有控制权，设备只能响应从主设备发来的总线命令，总线的信息传输由主设备启动
	* 多台主设备要同时使用总线时，就要由总线控制器判优，确定优先级
	* 从设备对总线没控制权  

* 总线判优控制可分为分布式和集中式
	* 集中式，将控制逻辑集中在一处，如 CPU 中
	* 分布式，将控制逻辑分散在与总线相连的各部件
* 常见优先权仲裁方式 
	* 链式查询：
		* 需要的线很少，容易扩充
		* 对电路故障敏感
		* 优先级低的设备很难获得请求
		* $2$根线确定总线使用权归哪个设备
	* 计数器定时查询：
		* 计数可以从0开始，也可以从上次计数终点开始
		* 可以由程序设置初始值，优先次序可以改变
		* 对电路故障不如链式查询敏感
		* 增加了控制线数，复杂一些
		* 大致$log_2n$根线确定总线使用权归哪个设备,n是允许接纳的最大设备数
	* 独立请求方式：
		* 每台设备有一对一总线请求线和总线同意线
		* 响应速度快，优先次序控制灵活
		* 控制线多，总线控制更复杂
		* $2n$根线确定总线使用权归哪个设备

### 3.5.2 总线通信控制

* 通信时间上，按分时方式处理

* 完成一次总线操作的时间称为总线周期

  1. 申请分配阶段
  2. 寻址阶段
  3. 传数阶段
  4. 结束阶段

* 总线通信控制主要解决双方如何获知传输开始和传输结束，以及通信双方如何协调配合

* 通信控制四种方式：同步通信、异步通信、半同步通信、分离式通信

* 同步通信：

  * 通信双方由同意时标控制数据传输，时标通常由CPU的总线控制部件发出
  * 优点：规定明确、统一，模块间配合简单一致
  * 缺点：主从模块时间配合强制性同步，必须在限定时间内完成规定要求；对所有从模块同一限时，速度慢的部件拖累公共时钟，影响效率

* 异步通信

  * 允许各模块速度的不一致性，没有公共时钟标准，没有严格统一操作时间
  * 采用应答方式，请求+响应。增加了两条应答线
  * 应答方式分为不互锁（CPU向主存写信息）、半互锁（主设备锁，CPU访问共享存储器）、全互锁（网络通信），锁不锁其实就是看发信号之后是要等对面回应了后撤销还是直接干自己的事情等确认收到信号后再处理
  * 异步通信可用于并行传送或串行传送。串行传送没有同步时钟，不需要传送同步信号，传送速率用波特率衡量$bps$
  * 同步传送速度高于异步传送速度

* 半同步通信

	* 保留同步通信基本通信，同时又像异步通信那样允许不同速度的模块和谐工作
	* 对系统时钟频率不能要求太高，整体工作速度还不是很高

* 分离式通信

	* 各模块要占用主线都必须提出申请
	* 得到总线使用权后主模块在限定时间内向对方传送信息，采用同步方式
	* 各模块准备数据过程中不占用总线
	* 总线被占用时都做有效工作
	* 主要是大型计算机系统，普通微型计算机很少用

	