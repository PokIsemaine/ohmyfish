# 第10章 数据库恢复技术

## 10.1 事务的基本概念

### 事务

事务(Transaction)是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位。

事务和程序是两个概念
在关系数据库中，一个事务可以是一条SQL语句，一组SQL语句或整个程序
一个程序通常包含多个事务



事务是恢复和并发控制的基本单位

### 事务的 ACID 特性

* A 原子性：事务是数据库的逻辑工作单位。要么都做，要么都不做
* C 一致性：事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态
	* 一致性状态：数据库中只包含成功事务提交的结果
	* 不一致状态：数据库系统运行中发生故障，有些事务尚未完成就被迫中断；这些未完成事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态 
* I 隔离性：一个事务的执行不能被其他事务干扰
* D 持续性：一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。
	接下来的其他操作或故障不应该对其执行结果有任何影响


破坏事务ACID特性的因素

* 多个事务并行运行时，不同事务的操作交叉执行
* 事务在运行过程中被强行停止



## 10.2 数据库恢复概述

**故障不可避免**

故障的影响：影响数据库中数据的正确性 ；破坏数据库，全部或部分丢失数据



数据库的恢复

* 数据库管理系统必须具有把数据库从错误状态恢复到某一已知的正确状态(亦称为一致状态或完整状态)的功能，这就是数据库的恢复管理系统对故障的对策
* 恢复子系统是数据库管理系统的一个重要组成部分 
* 恢复技术是衡量系统优劣的重要指标

## 10.3 故障的种类

### 事务内部的故障

事务内部的故障

* 有的是可以通过事务程序本身发现的
* 有的是非预期的，不能由事务程序处理的。 

事务故障意味着

* 事务没有达到预期的终点(COMMIT或者显式的ROLLBACK)
* 数据库可能处于不正确状态。 

事务故障的恢复：事务撤消（UNDO）

* 强行回滚（ROLLBACK）该事务
* 撤销该事务已经作出的任何对数据库的修改，使得该事务象根本没有启动一样

## 系统故障

称为软故障，是指造成系统停止运转的任何事件，使得系统要重新启动。 

* 整个系统的正常运行突然被破坏
* 所有正在运行的事务都非正常终止
* 不破坏数据库
* 内存中数据库缓冲区的信息全部丢失



常见原因

* 特定类型的硬件错误（如CPU故障）
* 操作系统故障
* 数据库管理系统代码错误
* 系统断电



系统故障的恢复

* 已送入物理数据库：事务回滚，强行撤消（UNDO）

* 还没写到物理数据库：系统重新启动时，恢复程序需要重做（REDO）所有已提交的事务



### 介质故障

称为硬故障，指外存故障

* 磁盘损坏
* 磁头碰撞
* 瞬时强磁场干扰

介质故障破坏数据库或部分数据库，并影响正在存取这部分数据的所有事务 
介质故障比前两类故障的可能性小得多，但破坏性大得多



### 计算机病毒

人为的、可繁殖和传播的，可大可小，潜伏期不定，攻击范围不定



计算机病毒已成为计算机系统的主要威胁，自然也是数据库系统的主要威胁 
数据库一旦被破坏仍要用恢复技术把数据库加以恢复



### 小结

各类故障，对数据库的影响有两种可能性

* 数据库本身被破坏
* 数据库没有被破坏，但数据可能不正确，这是由于事务的运行被非正常终止造成的。



## 10.4 恢复的实现技术

恢复操作的基本原理：冗余

* 数据转储
* 登记日志文件

恢复的实现技术：复杂



### 10.4.1 数据转储

什么是数据转储

* 转储是指数据库管理员定期地将整个数据库复制到磁带、磁盘或其他存储介质上保存起来的过程
* 备用的数据文本称为后备副本(backup)或后援副本
* 数据库遭到破坏后可以将后备副本重新装入
* **重装后备副本只能将数据库恢复到转储时的状态**
* **要想恢复到故障发生时的状态，必须重新运行自转储以后的所有更新事务**



转储方法

* 静态转储
	* 在系统中无运行事务时进行的转储操作
	* 转储开始时数据库处于一致性状态
	* 转储期间不允许对数据库的任何存取、修改活动
	* 得到的一定是一个数据一致性的副本 
	* 优点：实现简单
	* 缺点：降低了数据库的可用性，转储必须等待正运行的用户事务结束 ，新的事务必须等转储结束
* 动态转储
	* 转储操作与用户事务并发进行
	* 转储期间允许对数据库进行存取或修改
	* 优点：不用等待正在运行的用户事务结束，不会影响新事务的运行
	* 缺点：不能保证副本中的数据正确有效（靠建立日志文件来恢复）
* 海量转储: 每次转储全部数据库，恢复更方便
* 增量转储: 只转储上次转储后更新过的数据，适合大的、事务处理频繁的数据库



### 10.4.2 登记日志文件

**日志文件的格式和内容**

以记录为单位的日志文件内容

* 各个事务的开始标记(BEGIN TRANSACTION)
* 各个事务的结束标记(COMMIT或ROLLBACK)
* 各个事务的所有更新操作

以记录为单位的日志文件，每条日志记录的内容

* 事务标识（标明是哪个事务） 
* 操作类型（插入、删除或修改）
* 操作对象（记录ID、Block NO.）更新前数据的旧值（对插入操作而言，此项为空值）
* 更新后数据的新值（对删除操作而言, 此项为空值）



数据块为单位的日志文件，每条日志记录的内容

* 事务标识
* 被更新的数据块



**日志文件的作用**

* 协助后备副本进行介质故障恢复
* 事务故障恢复和系统故障恢复必须用日志文件。
* 在动态转储方式中必须建立日志文件，后备副本和日志文件结合起来才能有效地恢复数据库。



**登记日志文件**

为保证数据库是可恢复的，登记日志文件时必须遵循两条原则

* 登记的次序严格按并发事务执行的时间次序
* 必须先写日志文件，后写数据库



区分

写日志文件操作：把表示这个修改的日志记录写到日志文件中；

写数据库操作：把对数据的修改写到数据库中



## 10.5 恢复策略

### 10.5.1 事务故障的恢复

* 事务故障：事务在运行至正常终止点前被终止
* 恢复方法：利用日志文件 UNDO
* 系统自动完成，对用户透明



恢复步骤

1. 反向扫描文件日志（即从最后向前扫描日志文件），查找该事务的更新操作
2. 对该事务的更新操作执行逆操作。即将日志记录中“更新前的值” 写入数据库。（逆向操作）

3. 继续反向扫描日志文件，查找该事务的其他更新操作，并做同样处理。
4. 如此处理下去，直至读到此事务的开始标记，事务故障恢复就完成了。



### 10.5.2 系统故障的恢复

系统故障造成数据库不一致状态的原因

* 未完成事务对数据库的更新可能已写入数据库
* 已提交事务对数据库的更新可能还留在缓冲区没来得及写入数据库

恢复方法

* Undo 故障发生时未完成的事务
* Redo 已完成的事务

系统故障的恢复由系统在重新启动时自动完成，不需要用户干预



恢复步骤

1. 正向扫描日志文件（即从头扫描日志文件）
	* 重做(REDO) 队列: 在故障发生前已经提交的事务，这些事务既有BEGIN TRANSACTION记录，也有COMMIT记录
	* 撤销 (UNDO)队列:故障发生时尚未完成的事务，这些事务只有BEGIN TRANSACTION记录，无相应的COMMIT记录
2. 对撤销(UNDO)队列事务进行撤销(UNDO)处理
	* 反向扫描日志文件，对每个撤销事务的更新操作执行逆操作
	* 即将日志记录中“更新前的值”写入数据库 
3. 对重做(REDO)队列事务进行重做(REDO)处理
	* 正向扫描日志文件，对每个重做事务重新执行登记的操作
	* 即将日志记录中“更新后的值”写入数据库 



### 10.5.3 介质故障的恢复

恢复方法

* 重装数据库
* 重做已完成的事务



恢复步骤

1. 装入最新的后备数据库副本(离故障发生时刻最近的转储副本) ，使数据库恢复到最近一次转储时的一致性状态。
	* 对于静态转储的数据库副本，装入后数据库即处于一致性状态
	* 对于动态转储的数据库副本，还须同时装入转储时刻的日志文件副本，利用恢复系统故障的方法（即REDO+UNDO），才能将数据库恢复到一致性状态。
2. 装入有关的日志文件副本(转储结束时刻的日志文件副本) ，重做已完成的事务。
	* 首先扫描日志文件，找出故障发生时已提交的事务的标识，将其记入重做队列。
	* 然后正向扫描日志文件，对重做队列中的所有事务进行重做处理。即将日志记录中“更新后的值”写入数据库。



介质故障的恢复**需要数据库管理员介入**
数据库管理员的工作

* 重装最近转储的数据库副本和有关的各日志文件副本
* 执行系统提供的恢复命令

具体的恢复操作仍由数据库管理系统完成





## 10.6 具有检查点的恢复技术

### 问题提出

问题

* 搜索整个日志将耗费大量的时间
* 重做处理：重新执行，浪费了大量时间

解决方案：具有检查点（checkpoint）的恢复技术

* 在日志文件中增加检查点记录（checkpoint）
* 增加重新开始文件
* 恢复子系统在登录日志文件期间动态地维护日志



### 检查点技术

检查点记录的内容

* 建立检查点时刻所有正在执行的事务清单
* 这些事务最近一个日志记录的地址

重新开始文件的内容：记录各个检查点记录在日志文件中的地址



动态恢复日志文件的方法

动态维护日志文件的方法
周期性地执行如下操作：建立检查点，保存数据库状态。
具体步骤是：

1. 将当前日志缓冲区中的所有日志记录写入磁盘的日志文件上
2. 在日志文件中写入一个检查点记录
3. 将当前数据缓冲区的所有数据记录写入磁盘的数据库中
4. 把检查点记录在日志文件中的地址写入一个重新开始文件



建立检查点：恢复子系统可以定期或不定期地建立检查点,保存数据库状态 



利用检查点的恢复策略：使用检查点方法可以改善恢复效率

* 当事务T在一个检查点之前提交，T对数据库所做的修改已写入数据库
* 写入时间是在这个检查点建立之前或在这个检查点建立之时 
* 在进行恢复处理时，没有必要对事务T执行重做操作



利用检查点的恢复步骤

1. 从重新开始文件中找到最后一个检查点记录在日志文件中的地址，由该地址在日志文件中找到最后一个检查点记录
2. 由该检查点记录得到检查点建立时刻所有正在执行的事务清单ACTIVE-LIST
3. 从检查点开始正向扫描日志文件，直到日志文件结束
4. 对UNDO-LIST中的每个事务执行UNDO操作,   对REDO-LIST中的每个事务执行REDO操作



## 10.7 数据库镜像

数据库镜像

* 数据库管理系统自动把整个数据库或其中的关键数据复制到另一个磁盘上
* 数据库管理系统自动保证镜像数据与主数据的一致性

 每当主数据库更新时，数据库管理系统自动把更新后的数据复制过去



用途：出现介质故障时

* 可由镜像磁盘继续提供使用 
* 同时数据库管理系统自动利用镜像磁盘数据进行数据库的恢复
* 不需要关闭系统和重装数据库副本



频繁地复制数据自然会降低系统运行效率

* 在实际应用中用户往往只选择对关键数据和日志文件镜像
* 不是对整个数据库进行镜像

## 10.8 小结

